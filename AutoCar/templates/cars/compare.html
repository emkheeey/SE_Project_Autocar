{% load car_extras %}
{% load static %}

{% block title %}Compare Cars - AutoCar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/compare.css' %}">
{% endblock %}

{% block content %}
<header class="main-header">
    <div class="logo">
        <img src="{% static 'images/logo.png' %}" alt="AutoCar Logo">
    </div>
    <nav>
        <ul>
            <li><a href="{% url 'home' %}">HOME</a></li>
            <li><a href="{% url 'car_list' %}">BROWSE CARS</a></li>
            <li><a href="#">RECOMMENDATIONS</a></li>
            <li><a href="{% url 'compare_cars' %}">COMPARE CAR</a></li>
        </ul>
    </nav>
    <div class="profile-icon" onclick="toggleMenu()">
        <img src="{% static 'images/profileicon.png' %}" alt="Profile Icon">
    </div>
    <div class="user-menu" id="userMenu">
        <div class="menu-header">
            <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
            <div class="user-email">{{ user.email }}</div>
        </div>
        <div class="menu-item" onclick="window.location.href='#'">Account</div>
        <div class="menu-item" onclick="window.location.href='#'">Test Drives</div>
        <div class="menu-item" onclick="window.location.href='{% url 'logout' %}'">Log Out</div>
    </div>
</header>

<div class="compare-container">
    <h1>COMPARE CARS</h1>
    
    {% if car_count < 2 %}
    <div class="alert alert-warning">
        Please select at least 2 cars to compare.
        <a href="{% url 'car_list' %}" class="btn btn-primary btn-sm ms-3">Back to Car List</a>
    </div>
    {% else %}
    
    <div class="compare-cars">
        {% for car in cars %}
        <div class="car-selector">
            <h2>CAR {{ forloop.counter }}</h2>
            <div class="car-image">
                {% if car.image_url %}
                <img src="{{ car.image_url }}" alt="{{ car }}">
                {% endif %}
            </div>
            <h5>{{ car.year }} {{ car.make }} {{ car.model }}</h5>
            <button class="cancel-btn" onclick="removeCar({{ forloop.counter }})">Remove</button>
        </div>
        {% endfor %}
    </div>

    <!-- SCORE SUMMARY -->
    <div class="score-summary">
        <h2>Car Ratings</h2>
        <div class="score-cards">
            {% for score in car_scores %}
            <div class="score-card {% if forloop.first %}best-score{% endif %}">
                <div class="card-header">
                    <h5>{{ score.car.make }} {{ score.car.model }}</h5>
                    {% if forloop.first %}<span class="best-badge">BEST OVERALL</span>{% endif %}
                </div>
                <div class="card-body">
                    <div class="total-score">
                        <h3>{{ score.total_score }}%</h3>
                    </div>
                    
                    <div class="score-bars">
                        <div class="score-bar">
                            <label>Performance</label>
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ score.performance_score }}0%"></div>
                            </div>
                        </div>
                        
                        <div class="score-bar">
                            <label>Value</label>
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ score.value_score }}0%"></div>
                            </div>
                        </div>
                        
                        <div class="score-bar">
                            <label>Comfort & Space</label>
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ score.comfort_score }}0%"></div>
                            </div>
                        </div>
                        
                        <div class="score-bar">
                            <label>Features</label>
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ score.feature_score }}0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    {% if score.winning_categories %}
                    <div class="winning-categories">
                        <h6>Best In:</h6>
                        <ul>
                            {% for category in score.winning_categories %}
                            <li>✓ {{ category }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- DETAILED COMPARISON TABLE -->
    <div class="comparison-table-container">
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Specification</th>
                    {% for car in cars %}
                    <th>{{ car.year }} {{ car.make }} {{ car.model }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for category in spec_categories %}
                <tr class="category-header">
                    <td colspan="{{ car_count|add:1 }}">{{ category.name }}</td>
                </tr>
                {% for spec in category.specs %}
                <tr>
                    <td>{{ spec.name }}</td>
                    {% for car in cars %}
                    <td class="{% if car == best_car and spec.key == 'price' %}highlight-best{% endif %}">
                        {% with value=car|get_attr:spec.key %}
                            {% if value != None %}
                                {% if spec.format == 'currency' %}
                                    ₱{{ value|floatformat:2 }}
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            {% else %}
                                <span class="na">N/A</span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
    function toggleMenu() {
        const menu = document.getElementById('userMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    
    function removeCar(index) {
        // Get the current URL
        const url = new URL(window.location.href);
        
        // Get all car_id parameters
        const carIds = url.searchParams.getAll('car_id');
        
        // Remove the parameter at the specified index (adjusting for 0-based array)
        if (index > 0 && index <= carIds.length) {
            // Clear all car_id parameters
            url.searchParams.delete('car_id');
            
            // Add back all car_id parameters except the one to remove
            carIds.forEach((id, i) => {
                if (i !== index - 1) {
                    url.searchParams.append('car_id', id);
                }
            });
            
            // Redirect to the new URL
            window.location.href = url.toString();
        }
    }
</script>
{% endblock %}